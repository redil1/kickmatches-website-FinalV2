[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:postgresql-init]
command=/app/init-postgres.sh
user=root
autostart=true
autorestart=false
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=50
startsecs=0
exitcodes=0

[program:postgresql]
command=/app/start-postgres.sh
user=postgres
autostart=true
autorestart=true
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=100
startsecs=10

[program:postgresql-configure]
command=/app/configure-postgres.sh
user=root
autostart=true
autorestart=false
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=150
startsecs=0
exitcodes=0

[program:redis]
command=/usr/bin/redis-server --daemonize no --bind 0.0.0.0 --port 6379 --dir /var/lib/redis
user=redis
autostart=true
autorestart=true
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=200
startsecs=5

[program:db-migration]
command=/app/migrate-database.sh
user=nextjs
directory=/app
autostart=true
autorestart=false
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=250
startsecs=0
exitcodes=0
environment=NODE_ENV=production,PGPASSWORD=kickai

[program:nextjs]
command=/app/docker-entrypoint.sh
user=nextjs
directory=/app
autostart=true
autorestart=true
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=300
startsecs=10
environment=NODE_ENV=production,PORT=3000,HOSTNAME="0.0.0.0",PGPASSWORD=kickai

[program:worker]
command=/app/node_modules/.bin/tsx src/worker/standalone.ts
user=nextjs
directory=/app
autostart=true
autorestart=true
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
priority=400
startsecs=5
environment=NODE_ENV=production,PGPASSWORD=kickai

[group:services]
programs=postgresql-init,postgresql,postgresql-configure,redis,db-migration,nextjs,worker
priority=999