[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:postgresql-init]
command=/app/init-postgres.sh
user=root
autostart=true
autorestart=false
stderr_logfile=/var/log/postgresql/init.err.log
stdout_logfile=/var/log/postgresql/init.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=50
startsecs=0
exitcodes=0

[program:postgresql]
command=/usr/bin/postgres -D /var/lib/postgresql/data
user=postgres
autostart=true
autorestart=true
stderr_logfile=/var/log/postgresql/postgresql.err.log
stdout_logfile=/var/log/postgresql/postgresql.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=100
startsecs=10

[program:postgresql-configure]
command=/app/configure-postgres.sh
user=root
autostart=true
autorestart=false
stderr_logfile=/var/log/postgresql/configure.err.log
stdout_logfile=/var/log/postgresql/configure.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=150
startsecs=0
exitcodes=0

[program:redis]
command=/usr/bin/redis-server --daemonize no --bind 0.0.0.0 --port 6379 --dir /var/lib/redis
user=redis
autostart=true
autorestart=true
stderr_logfile=/var/log/redis/redis.err.log
stdout_logfile=/var/log/redis/redis.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=200
startsecs=5

[program:db-migration]
command=/app/migrate-database.sh
user=nextjs
directory=/app
autostart=true
autorestart=false
stderr_logfile=/var/log/supervisor/db-migration.err.log
stdout_logfile=/var/log/supervisor/db-migration.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=250
startsecs=0
exitcodes=0
environment=NODE_ENV=production,PGPASSWORD=kickai

[program:nextjs]
command=/app/docker-entrypoint.sh
user=nextjs
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/nextjs.err.log
stdout_logfile=/var/log/supervisor/nextjs.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=300
startsecs=10
environment=NODE_ENV=production,PORT=3000,HOSTNAME="0.0.0.0",PGPASSWORD=kickai

[program:worker]
command=/app/node_modules/.bin/tsx src/worker/standalone.ts
user=nextjs
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/worker.err.log
stdout_logfile=/var/log/supervisor/worker.out.log
stderr_logfile_maxbytes=10MB
stdout_logfile_maxbytes=10MB
stderr_logfile_backups=5
stdout_logfile_backups=5
priority=400
startsecs=5
environment=NODE_ENV=production,PGPASSWORD=kickai

[group:services]
programs=postgresql-init,postgresql,postgresql-configure,redis,db-migration,nextjs,worker
priority=999